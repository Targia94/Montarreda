<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Montarreda">
    <link rel="apple-touch-icon" href="static/icons/icon-192.png">
    <link rel="manifest" href="manifest.json">
    
    <title>Timbrature - Montarreda</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="static/css/style.css">
    
    <!-- Database and API -->
    <script src="static/js/db.js"></script>
    <script src="static/js/api.js"></script>
</head>
<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-cube text-primary"></i> Montarreda
            </div>
            <ul class="sidebar-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="timbrature.html" class="nav-link active">
                        <i class="fas fa-clock"></i> Timbrature
                    </a>
                </li>
                <li class="nav-item">
                    <a href="lavoro.html" class="nav-link">
                        <i class="fas fa-clipboard-list"></i> Lavoro
                    </a>
                </li>
                <li class="nav-item">
                    <a href="esportazione.html" class="nav-link">
                        <i class="fas fa-file-export"></i> Esportazione
                    </a>
                </li>
            </ul>
            <div class="p-3">
                <button class="btn btn-danger w-100" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Topbar -->
            <div class="topbar">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary d-md-none me-3" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h4 class="m-0">Gestione Timbrature</h4>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-secondary small">Giovanni</span>
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </div>

            <!-- Page Content -->
            <div class="content-wrapper">
                
                <div class="alert alert-warning d-none mb-4" id="noUsersWarning">
                    <i class="fas fa-exclamation-triangle me-2"></i> Nessun utente trovato! Assicurati di aver inserito almeno un utente nel database.
                </div>

                <div class="row g-4">
                    <!-- Colonna Sinistra: Inserimento -->
                    <div class="col-lg-5">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title">Nuova Timbratura</h5>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label text-secondary small fw-bold">Utente</label>
                                <select id="utente" class="form-select">
                                    <option value="" disabled selected>Seleziona un utente</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-secondary small fw-bold">Data</label>
                                <input type="date" id="data-timbratura" class="form-control">
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-6">
                                    <label class="form-label text-secondary small fw-bold">Ingresso</label>
                                    <div class="d-flex gap-1">
                                        <select id="ingresso-ore" class="form-select text-center"></select>
                                        <span class="align-self-center">:</span>
                                        <select id="ingresso-minuti" class="form-select text-center">
                                            <option value="00">00</option>
                                            <option value="15">15</option>
                                            <option value="30">30</option>
                                            <option value="45">45</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label text-secondary small fw-bold">Uscita</label>
                                    <div class="d-flex gap-1">
                                        <select id="uscita-ore" class="form-select text-center"></select>
                                        <span class="align-self-center">:</span>
                                        <select id="uscita-minuti" class="form-select text-center">
                                            <option value="00">00</option>
                                            <option value="15">15</option>
                                            <option value="30">30</option>
                                            <option value="45">45</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-primary w-100" onclick="salvaTimbratura()" id="salvaBtn">
                                <i class="fas fa-save me-2"></i> Salva Timbratura
                            </button>
                            <button class="btn btn-secondary w-100 d-none" id="loadingBtn" disabled>
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Salvataggio...
                            </button>
                        </div>
                    </div>

                    <!-- Colonna Destra: Resoconto -->
                    <div class="col-lg-7">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title">Resoconto Giornaliero</h5>
                            </div>
                            <ul id="resoconto" class="list-group list-group-flush">
                                <li class="list-group-item text-muted text-center py-5">
                                    <i class="fas fa-clock fa-3x mb-3 d-block opacity-25"></i>
                                    Seleziona utente e data per visualizzare le timbrature
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function logout() {
            localStorage.removeItem("token");
            window.location.href = "index.html";
        }

        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("open");
        }

        async function caricaTimbrature() {
            const id_utente = document.getElementById("utente").value;
            const data_timbratura = document.getElementById("data-timbratura").value;

            if (!id_utente || !data_timbratura) {
                return;
            }

            try {
                const timbrature = await API.getTimbrature(id_utente, data_timbratura);

                const resoconto = document.getElementById("resoconto");
                resoconto.innerHTML = ""; 

                if (timbrature.length === 0) {
                    resoconto.innerHTML = `<li class="list-group-item text-muted text-center py-4">
                        <i class="fas fa-calendar-times fa-2x mb-2 d-block opacity-25"></i>
                        Nessuna timbratura trovata per questa data
                    </li>`;
                    return;
                }

                timbrature.forEach(timbratura => {
                    resoconto.innerHTML += `
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="fas fa-calendar-day text-primary"></i>
                                    <strong>${timbratura.data}</strong>
                                </div>
                                <div class="small text-secondary">
                                    <span class="me-3"><i class="fas fa-sign-in-alt text-success me-1"></i> ${timbratura.orario_ingresso}</span>
                                    <span class="me-3"><i class="fas fa-sign-out-alt text-danger me-1"></i> ${timbratura.orario_uscita}</span>
                                    <span class="badge bg-light text-dark border"><i class="fas fa-hourglass-half me-1"></i> ${calcolaTempoLavorato(
                                        ...timbratura.orario_ingresso.split(":"),
                                        ...timbratura.orario_uscita.split(":")
                                    )} h</span>
                                </div>
                            </div>
                            <button class="btn btn-outline-danger btn-sm rounded-circle" style="width: 32px; height: 32px; padding: 0;" onclick="eliminaTimbratura(${timbratura.id})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </li>`;
                });

            } catch (error) {
                console.error("❌ Errore nel caricamento delle timbrature:", error);
                alert("Errore nel caricamento delle timbrature. Controlla il backend.");
            }
        }

        async function eliminaTimbratura(id) {
            if (!confirm("Sei sicuro di voler eliminare questa timbratura?")) return;

            try {
                await API.deleteTimbratura(id);

                // alert("Timbratura eliminata con successo!"); // Rimosso alert invasivo
                caricaTimbrature(); 
            } catch (error) {
                alert("❌ Errore nell'eliminazione: " + error.message);
            }
        }

        function resetForm() {
            document.getElementById("ingresso-ore").value = "07";
            document.getElementById("ingresso-minuti").value = "00";
            document.getElementById("uscita-ore").value = "17";
            document.getElementById("uscita-minuti").value = "00";
        }

        async function caricaUtenti() {
            try {
                const users = await API.getUsers();

                const select = document.getElementById("utente");
                select.innerHTML = '<option value="" disabled selected>Seleziona un utente</option>';

                if (users.length === 0) {
                    document.getElementById("noUsersWarning").classList.remove("d-none");
                } else {
                    document.getElementById("noUsersWarning").classList.add("d-none");
                }

                users.forEach(user => {
                    select.innerHTML += `<option value="${user.id}">${user.full_name}</option>`;
                });

            } catch (error) {
                console.error("❌ Errore nel fetch utenti:", error);
                alert("Errore nel caricamento degli utenti. Controlla il backend.");
            }
        }

        function popolaOre() {
            const oreIngresso = ["06", "07", "08", "09", "10", "11", "12"]; 
            const oreUscita = ["13", "14", "15", "16", "17", "18", "19", "20", "21"]; 

            const oreSelectIngresso = document.getElementById("ingresso-ore");
            const oreSelectUscita = document.getElementById("uscita-ore");

            oreSelectIngresso.innerHTML = "";
            oreSelectUscita.innerHTML = "";

            oreIngresso.forEach(ora => {
                const option = document.createElement("option");
                option.value = ora;
                option.textContent = ora;
                oreSelectIngresso.appendChild(option);
            });

            oreUscita.forEach(ora => {
                const option = document.createElement("option");
                option.value = ora;
                option.textContent = ora;
                oreSelectUscita.appendChild(option);
            });

            oreSelectIngresso.value = "07"; 
            oreSelectUscita.value = "17"; 
        }

        function calcolaTempoLavorato(ingressoOre, ingressoMinuti, uscitaOre, uscitaMinuti) {
            const ingresso = parseInt(ingressoOre) * 60 + parseInt(ingressoMinuti);
            const uscita = parseInt(uscitaOre) * 60 + parseInt(uscitaMinuti);
            const differenzaMinuti = uscita - ingresso;

            const ore = Math.floor(differenzaMinuti / 60);
            const minuti = differenzaMinuti % 60;

            return `${ore}:${minuti.toString().padStart(2, "0")}`;
        }

        async function salvaTimbratura() {
            const id_utente = document.getElementById("utente").value;
            const utenteNome = document.getElementById("utente").selectedOptions[0]?.text;
            const data_timbratura = document.getElementById("data-timbratura").value;
            const ingresso_ore = document.getElementById("ingresso-ore").value;
            const ingresso_minuti = document.getElementById("ingresso-minuti").value;
            const uscita_ore = document.getElementById("uscita-ore").value;
            const uscita_minuti = document.getElementById("uscita-minuti").value;

            if (!id_utente || !data_timbratura || !ingresso_ore || !uscita_ore) {
                alert("Compila tutti i campi!");
                return;
            }

            const orario_ingresso = `${ingresso_ore}:${ingresso_minuti}`;
            const orario_uscita = `${uscita_ore}:${uscita_minuti}`;

            document.getElementById("salvaBtn").classList.add("d-none");
            document.getElementById("loadingBtn").classList.remove("d-none");

            const payload = {
                id_utente: parseInt(id_utente),
                data: data_timbratura,  
                orario_ingresso: orario_ingresso,
                orario_uscita: orario_uscita
            };

            try {
                const result = await API.saveTimbratura(payload, false);

                if (result.modifica) {
                    if (confirm("Esiste già una timbratura per questa data. Vuoi sovrascriverla?")) {
                        await API.saveTimbratura(payload, true);
                        // alert("Timbratura aggiornata con successo!");
                        caricaTimbrature();
                    }
                } else {
                    // alert("Timbratura registrata con successo!");
                    caricaTimbrature();
                }
                // caricaUtenti(); // Non ricaricare utenti, resetta solo il form se necessario
                
                resetForm();
            } catch (error) {
                alert(`❌ Errore: ${error.message}`);
            } finally {
                document.getElementById("salvaBtn").classList.remove("d-none");
                document.getElementById("loadingBtn").classList.add("d-none");
            }
        }

        window.onload = function() {
            caricaUtenti();
            popolaOre();

            document.getElementById("utente").addEventListener("change", caricaTimbrature);
            document.getElementById("data-timbratura").addEventListener("change", caricaTimbrature);
        };
        
        // Registrazione Service Worker per PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('[PWA] Service Worker registrato', reg))
                    .catch(err => console.log('[PWA] Errore registrazione SW', err));
            });
        }
    </script>

</body>
</html>
